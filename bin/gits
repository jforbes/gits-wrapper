#!/usr/bin/perl

use Cwd;

my @args = @ARGV;

my %params = ();
while (my $arg = shift @args) {
      my ($param,$value) = $arg =~ m!^([^=]+)=(.*)$!;  # can unset something
      unshift @args, $arg and last unless $param;
      $params{$param} = $value;
}

$params{wd} ||= $ENV{GITSDIR};
chdir( $params{wd} ) or die "failed to chdir($params{wd})" if $params{wd};
my $wd = getcwd;

$params{b} = $ENV{GITSBRANCH} unless defined $params{b};

my $command = shift @args;


my @repos;
while(my $str = pop @args){
      if(-d $str && -d "$str/.git"){
	    $str =~ s/\/$//g;
	    unshift @repos, $str;
      }else{
	    push @args, $str;
	    last;
      }
}

unless(@repos){
      foreach my $str ( glob('*') ){
	    if(-d $str && -d "$str/.git"){
                  if ($params{b}) {
                        chdir "$wd/$str" or die "failed to chdir $wd/$str";
                        chomp( my @branches = `git branch` );
                        my %bmap = map { $_ => 1 } map { $_ =~ m!..(.+)! } @branches;
                        push @repos, $str if exists $bmap{$params{b}};
                        chdir "$wd";
                  }
                  else {
                        push @repos, $str;
                  }
	    }
      }
}

foreach my $repo (@repos){
      print "\n =================== $repo ===================\n";
      chdir "$wd/$repo" or die "failed to chdir $wd/$repo";
      system('git',$command,@args) and die $!;
}
